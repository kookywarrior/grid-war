(()=>{"use strict";const e=16,t=9,i=50,s=4,o=1,n=.3,d=200,a=200,l=2e3,r=.1,h=50,m="ws://localhost:4567/",w=class{constructor(e){this.id=e,this.active=!1,this.alive=!1,this.width=s,this.height=s,this.wiggle=0,this.xWiggle=0,this.yWiggle=0}spawn(e,t,i,s){this.active=!0,this.alive=!0,this.x=e,this.y=t,this.x2=e,this.y2=t,this.name=i,this.score=s,this.targetScore=s,this.wiggle=0,this.xWiggle=0,this.yWiggle=0}shake(e){"left"===e?(this.xWiggle=-1,this.yWiggle=0):"right"===e?(this.xWiggle=1,this.yWiggle=0):"top"===e?(this.xWiggle=0,this.yWiggle=-1):"bottom"===e&&(this.xWiggle=0,this.yWiggle=1),window.myBorder.wiggle=r}update(e,t,i){this.wiggle=0,this.x2=e,this.y2=t,i?(this.x1=this.x,this.y1=this.y,this.startTime=null):(this.x=e,this.y=t)}updateScore(e){this.targetScore=e,0===e&&(this.score=0,document.getElementById("scoreDisplay").textContent="Score: "+this.score)}},c=class{constructor(){this.borders=[]}findBorder(e){for(const t of this.borders)if(t.id===e)return t;return null}spawnBorder(e,t,i,s,o){let n=this.findBorder(e);if(n);else{for(const t of this.borders)if(!t.active){n=t,n.id=e;break}n||(n=new w(e),this.borders.push(n))}return n.spawn(i,s,t,o),n}killBorder(e){const t=this.findBorder(e);t&&(t.alive=!1)}removeBorder(e){const t=this.findBorder(e);t&&(t.active=!1)}updateBorder(e,t,i,s){const o=this.findBorder(e);o&&o.update(t,i,s)}},y=(e,t,i,s)=>Math.sqrt((i-=e)*i+(s-=t)*s),g=(e,t,i,s)=>Math.atan2(t-s,e-i),u=(e,t)=>Math.floor(Math.random()*(t-e+1))+e,p=(e,t)=>{let i="";for(let s=0;s<e;s++)i+=t[Math.floor(Math.random()*t.length)];return i},v=e=>{for(let t=e.length-1;t>0;t--){const i=Math.floor(Math.random()*(t+1));[e[t],e[i]]=[e[i],e[t]]}},x=e=>{const t=[];for(let i=0;i<e.length;i++)for(let s=0;s<i+1;s++)t.push(e[i]);return t},f=e=>e>999?(e/1e3).toFixed(1)+"k":e,b=(e,t)=>e[(e.indexOf(t)+1)%e.length],T=document.getElementById("gameCanvas"),B=T.getContext("2d"),M=document.getElementById("minimap"),I=M.getContext("2d");function E(i){let s=100;"Potato"===i?s=50:"Low"===i?s=75:"Normal"===i?s=100:"High"===i?s=125:"Best"===i&&(s=150);const o=s/100;window.scaleFillNative=Math.max(window.innerWidth/e,window.innerHeight/t)*o,T.width=window.innerWidth*o,T.height=window.innerHeight*o,T.style.width=window.innerWidth+"px",T.style.height=window.innerHeight+"px",B.setTransform(window.scaleFillNative,0,0,window.scaleFillNative,(window.innerWidth*o-e*window.scaleFillNative)/2,(window.innerHeight*o-t*window.scaleFillNative)/2)}let k=Date.now(),S=0,A=k,L={};function C(e){const t=e.x+(e.border.x+e.border.wiggle*e.border.xWiggle)-L.x,i=e.y+(e.border.y+e.border.wiggle*e.border.yWiggle)-L.y;F(t,i,o,o)&&(B.save(),B.globalAlpha=e.opacity,B.translate(t,i),B.translate(o/2,o/2),B.scale(e.scale,e.scale),B.translate(-o/2,-o/2),B.fillStyle=e.bgColour,B.fillRect(.05,.05,o-.1,o-.1),B.textBaseline="middle",B.textAlign="center",B.fillStyle=e.textColour,B.font="0.4px Bebas Neue",B.fillText(e.value,o/2,o/2+.05),B.restore())}function W(e){return e*e*(3-2*e)}function N(e){return e<.5?2*e*e:(4-2*e)*e-1}function F(i,s,o,n){return!(i+o<0||s+n<0||i>e||s>t)}function D(e,t){localStorage.setItem(e,t)}function R(e){return localStorage.getItem(e)}window.camera={x:i/2,y:i/2};const Q=class{constructor(e){this.sid=e,this.active=!1,this.mergedTiles=[],this.scale=0,this.opacity=0}spawn(e,t,i,s,o,n=[]){this.value=e,this.x=t,this.y=i,this.x2=t,this.y2=i,this.borderId=s,this.border=null,this.active=!0;const d=100-8*Math.log2(this.value),a=d<=50?90:10;this.bgColour=`hsl(${s===window.myId||"a"===s?200:0}, 50%, ${d}%)`,this.textColour=`hsl(${s===window.myId||"a"===s?200:0}, 25%, ${a}%)`,o?(this.scale=0,this.opacity=0,this.scaleStartTime=null):2===n.length?(this.scale=1,this.opacity=0,this.mergedTiles=n):(this.scale=1,this.opacity=1),this.opacityStartTime=null}update(e,t,i){this.x2=e,this.y2=t,i?(this.x1=this.x,this.y1=this.y,this.startTime=null):(this.x=e,this.y=t)}},V=class{constructor(){this.tiles=[]}findTile(e){for(const t of this.tiles)if(t.sid===e)return t;return null}addTile(e,t,i,s,o,n,d){let a=this.findTile(e);if(a);else{for(const t of this.tiles)if(!t.active){a=t,a.sid=e;break}a||(a=new Q(e),this.tiles.push(a))}return a.spawn(t,i,s,o,n,d),a}removeTile(e){const t=this.findTile(e);if(t&&(t.active=!1,2===t.mergedTiles.length)){const e=t.mergedTiles[0],i=t.mergedTiles[1];e.active&&(e.active=!1),i.active&&(i.active=!1),t.mergedTiles=[]}}updateTile(e,t,i,s){const o=this.findTile(e);o&&o.update(t,i,s)}mergeTile(e,t,i,s,o,n,d){const a=this.findTile(e),l=this.findTile(t);let r,h;if(a){let e;for(;e=p(16,"0123456789abcdef"),this.findTile(e););r=this.addTile(e,a.value,a.x,a.y,a.borderId,!1,[]),r.update(o,n,!0),this.removeTile(a.sid)}if(l){let e;for(;e=p(16,"0123456789abcdef"),this.findTile(e););h=this.addTile(e,l.value,l.x,l.y,l.borderId,!1,[]),h.update(o,n,!0),this.removeTile(l.sid)}null!=i&&this.addTile(i,s,o,n,d,!1,[r,h])}};function $(){const e=Array.from(document.getElementsByClassName("letterpixel"));v(e),e.forEach((e=>{const t=100-8*u(6,11);e.style.backgroundColor=`hsl(${Math.random()<.5?200:0}, 50%, ${t}%)`,e.classList.contains("lettershow")&&e.classList.remove("lettershow"),setTimeout((()=>{e.classList.add("lettershow")}),u(0,1e3))}))}function q(e){document.getElementById("spawnContainer").style.display="none",document.getElementById("loadingContainer").style.display="none",document.getElementById("disconnectContainer").style.display="none",document.getElementById(e).style.display=null}const z=class{constructor(e,t,i){this.borderManager=e,this.tileManager=t,this.handleMessages=i,this.mobileAndTablet=function(){let e=!1;var t;return t=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4)))&&(e=!0),e},window.VARIABLES.tutorial=!0,window.ws&&window.ws.close(),window.sendMovement=()=>{},this.borderManager.borders=[],this.tileManager.tiles=[],window.myId="me",this.step1()}text(e){const t=e.split("\n").map((e=>`<span class="tutorialBoxNewLine">${e}</span>`));document.getElementById("tutorialBox").innerHTML=t.join("")}step1(){this.text("Welcome to Grid War!\n"+(this.mobileAndTablet()?"Swipe left, right, up, or down to move the tiles":"Use the arrow keys or WASD to move the tiles")+"\nNow, try moving LEFT"),window.sendMovement=e=>{"left"===e&&this.step2()},this.handleMessages("addBorder",{id:"me",name:"me",x:i/2,y:1,score:0,noUi:!0}),this.handleMessages("addTile",{sid:1,value:2,x:1,y:1,borderId:"me"}),this.handleMessages("addTile",{sid:2,value:2,x:2,y:2,borderId:"me"}),this.handleMessages("addBorder",{id:"enemy1",name:"enemy1",x:i/2-6,y:0,score:0}),this.handleMessages("addTile",{sid:101,value:4,x:3,y:0,borderId:"enemy1"}),this.handleMessages("addTile",{sid:102,value:2,x:0,y:1,borderId:"enemy1"}),this.handleMessages("addTile",{sid:103,value:2,x:3,y:1,borderId:"enemy1"}),this.handleMessages("addTile",{sid:104,value:2,x:1,y:3,borderId:"enemy1"}),this.handleMessages("addBorder",{id:"enemy2",name:"enemy2",x:i/2-10,y:2,score:0}),this.handleMessages("addTile",{sid:201,value:4,x:2,y:0,borderId:"enemy2"}),this.handleMessages("addTile",{sid:202,value:2,x:3,y:0,borderId:"enemy2"}),this.handleMessages("addTile",{sid:203,value:4,x:2,y:1,borderId:"enemy2"})}step2(){this.text("The tiles all moved in the same direction, and a new tile appeared\nTry moving UP to bring 2 and 2 together"),window.sendMovement=e=>{"top"===e&&this.step3()},this.handleMessages("slideBorder",{id:"me",x:i/2-1,y:1}),this.handleMessages("slideTile",{sid:1,x:0,y:1}),this.handleMessages("slideTile",{sid:2,x:0,y:2}),this.handleMessages("showTile",{sid:3,value:2,x:1,y:2,borderId:"me"})}step3(){this.text("Tiles with the same number combine when they collide, 2 + 2 = 4\nNow, move LEFT"),window.sendMovement=e=>{"left"===e&&this.step4()},this.handleMessages("slideBorder",{id:"me",x:i/2-1,y:0}),this.handleMessages("mergeTile",{sid1:1,sid2:2,merge:4,value:4,x:0,y:0,borderId:"me"}),this.handleMessages("slideTile",{sid:3,x:1,y:0}),this.handleMessages("showTile",{sid:5,value:2,x:0,y:3,borderId:"me"})}step4(){this.text("If no tiles can move or combine, your board will shake to show that the move is invalid\nNow, move UP"),window.sendMovement=e=>{"top"===e&&this.step5()},this.handleMessages("invalidMove",{direction:"left"})}step5(){this.text("If your board cannot move, it will stay in place\nHowever, the tiles will continue moving or combining as long as it is not an invalid move\nNow, move LEFT"),window.sendMovement=e=>{"left"===e&&this.step6()},this.handleMessages("slideTile",{sid:5,x:0,y:1}),this.handleMessages("showTile",{sid:6,value:2,x:3,y:1,borderId:"me"})}step6(){this.text("When the enemy's board is beside you, you can try to destroy the board by making a successful collision with it!\nNow, move LEFT"),window.sendMovement=e=>{"left"===e&&this.step7()},this.handleMessages("slideBorder",{id:"me",x:i/2-2,y:0}),this.handleMessages("mergeTile",{sid1:5,sid2:6,merge:7,value:4,x:0,y:1,borderId:"me"}),this.handleMessages("showTile",{sid:8,value:2,x:3,y:0,borderId:"me"})}step7(){this.text("Your collision with the enemy's board was unsuccessful because the tiles that meet each other must have a higher value on your side than on the enemy's side\nNow, try making an 8 by moving LEFT"),window.sendMovement=e=>{"left"===e&&this.step8()},this.handleMessages("mergeTile",{sid1:3,sid2:8,merge:9,value:4,x:1,y:0,borderId:"me"}),this.handleMessages("showTile",{sid:10,value:2,x:0,y:3,borderId:"me"})}step8(){this.text("Now, you should be able to destroy the enemy's board\nMove LEFT"),window.sendMovement=e=>{"left"===e&&this.step9()},this.handleMessages("mergeTile",{sid1:4,sid2:9,merge:11,value:8,x:0,y:0,borderId:"me"}),this.handleMessages("showTile",{sid:12,value:2,x:3,y:0,borderId:"me"})}step9(){this.text("Boom! You have successfully destroyed it\nNow, move LEFT to try to get near the next enemy's board"),window.sendMovement=e=>{"left"===e&&this.step10()},this.handleMessages("removeTile",{sid:101}),this.handleMessages("removeTile",{sid:102}),this.handleMessages("removeTile",{sid:103}),this.handleMessages("removeTile",{sid:104}),this.handleMessages("removeBorder",{id:"enemy1"}),this.handleMessages("slideBorder",{id:"me",x:i/2-3,y:0}),this.handleMessages("slideTile",{sid:12,x:1,y:0}),this.handleMessages("showTile",{sid:13,value:2,x:2,y:1,borderId:"me"})}step10(){this.text("Move LEFT to try to get near the next enemy's board"),window.sendMovement=e=>{"left"===e&&this.step11()},this.handleMessages("slideBorder",{id:"me",x:i/2-4,y:0}),this.handleMessages("slideTile",{sid:13,x:1,y:1}),this.handleMessages("showTile",{sid:14,value:2,x:3,y:0,borderId:"me"})}step11(){this.text("Move LEFT to try to get near the next enemy's board"),window.sendMovement=e=>{"left"===e&&this.step12()},this.handleMessages("slideBorder",{id:"me",x:i/2-5,y:0}),this.handleMessages("mergeTile",{sid1:12,sid2:14,merge:15,value:4,x:1,y:0,borderId:"me"}),this.handleMessages("showTile",{sid:16,value:4,x:3,y:3,borderId:"me"})}step12(){this.text("Move LEFT to try colliding with the next enemy's board"),window.sendMovement=e=>{"left"===e&&this.step13()},this.handleMessages("slideBorder",{id:"me",x:i/2-6,y:0}),this.handleMessages("slideTile",{sid:16,x:1,y:3}),this.handleMessages("showTile",{sid:17,value:2,x:3,y:1,borderId:"me"})}step13(){this.text("Your collision with the enemy's board was unsuccessful because at least one tile from each side must meet at the edge of the board\nNow, move DOWN"),window.sendMovement=e=>{"bottom"===e&&this.step14()},this.handleMessages("mergeTile",{sid1:13,sid2:17,merge:18,value:4,x:1,y:1,borderId:"me"}),this.handleMessages("showTile",{sid:19,value:2,x:3,y:3,borderId:"me"})}step14(){this.text("Now, 2 from the enemy's board and 8 from your board meet\nMove LEFT to destroy it"),window.sendMovement=e=>{"left"===e&&this.step15()},this.handleMessages("slideBorder",{id:"me",x:i/2-6,y:1}),this.handleMessages("slideTile",{sid:11,x:0,y:1}),this.handleMessages("slideTile",{sid:7,x:0,y:2}),this.handleMessages("slideTile",{sid:15,x:1,y:2}),this.handleMessages("mergeTile",{sid1:16,sid2:18,merge:20,value:8,x:1,y:3,borderId:"me"}),this.handleMessages("showTile",{sid:21,value:2,x:3,y:2,borderId:"me"})}step15(){this.text("Boom! You have successfully destroyed it\nNow, get ready for action in Grid War!\n"+(this.mobileAndTablet()?"Tap anywhere to continue...":"Press any key to continue...")),this.handleMessages("removeTile",{sid:201}),this.handleMessages("removeTile",{sid:202}),this.handleMessages("removeTile",{sid:203}),this.handleMessages("removeBorder",{id:"enemy2"}),this.handleMessages("slideBorder",{id:"me",x:i/2-7,y:1}),this.handleMessages("slideTile",{sid:19,x:2,y:3}),this.handleMessages("slideTile",{sid:21,x:1,y:2}),this.handleMessages("mergeTile",{sid1:7,sid2:15,merge:22,value:8,x:0,y:2,borderId:"me"}),this.handleMessages("showTile",{sid:23,value:2,x:0,y:0,borderId:"me"}),window.onkeydown=e=>{window.location.reload()},window.ontouchstart=e=>{window.location.reload()}}};document.addEventListener("DOMContentLoaded",(async function(){$();const o=new V,r=new c;r.spawnBorder("b",null,i/2,i/2-2,0),r.spawnBorder("a",null,i/2-4,i/2-2,0);const w=x([1024,512,256,128,64,32,16,8,4,2]);Array.from(["a","b"]).forEach((e=>{for(let t=0;t<4;t++)for(let i=0;i<4;i++)if(Math.random()<.6){const s=w[Math.floor(Math.random()*w.length)];o.addTile(o.tiles.length+1,s,t,i,e,!1,[])}})),window.VARIABLES={graphicsQuality:"Normal",name:"",tutorial:!1};const u=[];window.sendMovement=()=>{};let p={};window.onkeydown=e=>{"Escape"===e.code&&e.event.preventDefault(),null!=window.myBorder&&window.myBorder.active&&(p[e.code]=!0,"KeyA"===e.code||"ArrowLeft"===e.code?window.sendMovement("left"):"KeyD"===e.code||"ArrowRight"===e.code?window.sendMovement("right"):"KeyW"===e.code||"ArrowUp"===e.code?window.sendMovement("top"):"KeyS"!==e.code&&"ArrowDown"!==e.code||window.sendMovement("bottom"))},window.onkeypress=e=>{"Escape"===e.code&&e.preventDefault()},window.onkeyup=e=>{"Escape"===e.code&&e.preventDefault(),p[e.code]=!1};let v=0,T=0;window.ontouchstart=e=>{v=e.touches[0].clientX,T=e.touches[0].clientY},window.ontouchend=e=>{const t=e.changedTouches[0].clientX-v,i=e.changedTouches[0].clientY-T;Math.abs(t)>Math.abs(i)?t>h?window.sendMovement("right"):t<-h&&window.sendMovement("left"):i>h?window.sendMovement("bottom"):i<-h&&window.sendMovement("top")};let Q=R("graphicsQuality");function H(e,t){if("pong"===e){const e=new Date-u[0];u.shift(),document.getElementById("pingDisplay").textContent=`Ping: ${e} ms`}else if("connected"===e)window.myId=t.id,q("spawnContainer");else if("score"===e)null!=window.myBorder&&window.myBorder.updateScore(t.score);else if("leaderboard"===e)!function(e){const t=document.getElementById("leaderboardData");for(;t.hasChildNodes();)t.removeChild(t.lastChild);for(let i=0;i<e.length;i++){const s=e[i],o=document.createElement("div");o.classList.add("leaderHolder");const n=document.createElement("div");n.classList.add("leaderboardItem"),n.style.color=s.id===window.myId?"white":"lightgray",n.textContent=`${i+1}. ${s.name}`,o.appendChild(n);const d=document.createElement("div");d.classList.add("leaderScore"),d.textContent=f(s.score),o.appendChild(d),t.appendChild(o)}}(t.leaderboard);else if("invalidMove"===e)null!=window.myBorder&&window.myBorder.shake(t.direction);else if("addBorder"===e){const e=r.spawnBorder(t.id,t.name,t.x,t.y,t.score);if(t.id===window.myId){window.myBorder=e,e.updateScore(t.score);const i={x:window.myBorder.x+s/2,y:window.myBorder.y+s/2};window.camera={x:i.x,y:i.y},p={},function(e=!1){e?document.getElementById("tutorialContainer").style.display=null:document.getElementById("uiContainer").style.display=null,document.getElementById("menuContainer").classList.remove("menuOpacity"),q("spawnContainer")}(t.noUi)}}else"removeBorder"===e?r.removeBorder(t.id):"killBorder"===e?(r.killBorder(t.id),t.id===window.myId&&(document.getElementById("uiContainer").style.display="none",document.getElementById("diedText").style.display="none",document.getElementById("diedText").style.display=null,setTimeout((()=>{document.getElementById("diedText").style.display="none",document.getElementById("menuContainer").classList.contains("menuOpacity")||document.getElementById("menuContainer").classList.add("menuOpacity"),$()}),l))):"updateBorder"===e||"slideBorder"===e?r.updateBorder(t.id,t.x,t.y,"slideBorder"===e):"addTile"===e||"showTile"===e?o.addTile(t.sid,t.value,t.x,t.y,t.borderId,"showTile"===e,[]):"removeTile"===e?o.removeTile(t.sid):"updateTile"===e||"slideTile"===e?o.updateTile(t.sid,t.x,t.y,"slideTile"===e):"mergeTile"===e&&o.mergeTile(t.sid1,t.sid2,t.merge,t.value,t.x,t.y,t.borderId)}Q&&(window.VARIABLES.graphicsQuality=Q),document.getElementById("qualitySettings").textContent=`Quality: ${window.VARIABLES.graphicsQuality}`,document.getElementById("qualitySettings").onclick=function(){window.VARIABLES.graphicsQuality=b(["Potato","Low","Normal","High","Best"],window.VARIABLES.graphicsQuality),D("graphicsQuality",window.VARIABLES.graphicsQuality),document.getElementById("qualitySettings").textContent=`Quality: ${window.VARIABLES.graphicsQuality}`},window.onresize=()=>{E(window.VARIABLES.graphicsQuality)},E(window.VARIABLES.graphicsQuality),Q=R("name"),Q&&(window.VARIABLES.name=Q),document.getElementById("inputName").value=window.VARIABLES.name,document.getElementById("tutorial").onclick=()=>{new z(r,o,H)},document.getElementById("fullScreenButton").addEventListener("click",(async()=>{document.fullscreenElement?await document.exitFullscreen():await document.documentElement.requestFullscreen()})),document.addEventListener("fullscreenchange",(e=>{document.fullscreenElement?document.getElementById("fullScreenButton").innerHTML="&#xE5D1;":document.getElementById("fullScreenButton").innerHTML="&#xE5D0;"})),window.ws=new WebSocket(m),window.ws.binaryType="arraybuffer",window.ws.onopen=()=>{window.ws.iosend=e=>{window.ws.send(window.msgpack.encode(e))},window.ws.iosend({type:"ping"}),u.push(new Date);const e=setInterval((()=>{window.ws.readyState===WebSocket.OPEN?(window.ws.iosend({type:"ping"}),u.push(new Date)):clearInterval(e)}),3e3);window.ws.onmessage=e=>{try{const{type:t,data:i}=window.msgpack.decode(new Uint8Array(e.data));H(t,i)}catch(e){console.error(e)}},window.sendMovement=e=>{window.ws.iosend({type:"move",data:{direction:e}})},window.ws.onclose=()=>{clearInterval(e),window.onbeforeunload=null,window.VARIABLES.tutorial||q("disconnectContainer")}},window.iosend=window.ws.iosend;let P=0;const O=[];window.requestAnimationFrame((function l(){const h=performance.now();for(;O.length>0&&O[0]<=h-1e3;)O.shift();O.push(h),P+=O.length,P>2e3&&(P=0,document.getElementById("fpsDisplay").textContent=`FPS: ${O.length}`),function(o,l){if(k=Date.now(),S=k-A,A=k,null!=window.myBorder){const e={x:window.myBorder.x+s/2,y:window.myBorder.y+s/2},t=y(window.camera.x,window.camera.y,e.x,e.y),i=Math.min(.01*t*S,t);if(t>.05){const t=g(e.x,e.y,window.camera.x,window.camera.y);window.camera.x+=i*Math.cos(t),window.camera.y+=i*Math.sin(t)}else window.camera={x:e.x,y:e.y};0!==window.myBorder.wiggle&&(window.myBorder.wiggle<.01?window.myBorder.wiggle=0:window.myBorder.wiggle*=Math.pow(.99,S)),window.myBorder.score!==window.myBorder.targetScore&&(window.myBorder.score<window.myBorder.targetScore?window.myBorder.score++:window.myBorder.score--,document.getElementById("scoreDisplay").textContent="Score: "+window.myBorder.score)}else window.camera={x:i/2,y:i/2};for(const e of o)if(e.active&&e.alive&&(e.x!==e.x2||e.y!==e.y2)){null===e.startTime&&(e.startTime=k);let t=(k-e.startTime)/d;t>=1&&(t=1),e.x=e.x1+(e.x2-e.x1)*N(t),e.y=e.y1+(e.y2-e.y1)*N(t),1===t&&(e.startTime=null,e.x=e.x2,e.y=e.y2)}for(const e of l)if(e.active){if(e.x!==e.x2||e.y!==e.y2){null===e.startTime&&(e.startTime=k);let t=(k-e.startTime)/d;t>=1&&(t=1),e.x=e.x1+(e.x2-e.x1)*N(t),e.y=e.y1+(e.y2-e.y1)*N(t),1===t&&(e.startTime=null,e.x=e.x2,e.y=e.y2)}if(1!==e.scale){null===e.scaleStartTime&&(e.scaleStartTime=k);let t=(k-e.scaleStartTime)/a;t>=1&&(t=1),e.scale=W(t),1===t&&(e.scaleStartTime=null,e.scale=1)}if("string"!=typeof e.sid&&1!==e.opacity||"string"==typeof e.sid&&0!==e.opacity){null===e.opacityStartTime&&(e.opacityStartTime=k);let t=(k-e.opacityStartTime)/a;if(t>=1&&(t=1),e.opacity="string"==typeof e.sid?1-W(t):W(t),1===t){if(e.opacityStartTime=null,e.opacity="string"==typeof e.sid?0:1,2===e.mergedTiles.length){const t=e.mergedTiles[0],i=e.mergedTiles[1];t.active&&(t.active=!1),i.active&&(i.active=!1),e.mergedTiles=[]}"string"==typeof e.sid&&(e.active=!1)}}if(e.borderId&&null==e.border)for(const t of o)if(t.id===e.borderId){e.border=t;break}}L={x:window.camera.x-e/2,y:window.camera.y-t/2},B.globalAlpha=1,B.fillStyle="rgb(50, 50, 50)",B.fillRect(0,0,e,t),B.globalAlpha=1,B.fillStyle="gray",B.shadowBlur=n*window.scaleFillNative;for(const e of o)if(e.active&&e.alive&&e.id!==window.myId){const t=e.x+e.wiggle*e.xWiggle-L.x+.05,i=e.y+e.wiggle*e.yWiggle-L.y+.05,s=e.width-.1,o=e.height-.1;F(t,i,s,o)&&(B.shadowColor="a"===e.id?"hsl(180, 100%, 80%)":"hsl(0, 100%, 80%)",B.fillRect(t,i,s,o))}if(null!=window.myBorder&&window.myBorder.active&&window.myBorder.alive){const e=window.myBorder.x+window.myBorder.wiggle*window.myBorder.xWiggle-L.x+.05,t=window.myBorder.y+window.myBorder.wiggle*window.myBorder.yWiggle-L.y+.05,i=window.myBorder.width-.1,s=window.myBorder.height-.1;F(e,t,i,s)&&(B.shadowColor="hsl(180, 100%, 80%)",B.fillRect(e,t,i,s))}B.shadowBlur=0;for(const e of l)e.active&&e.border&&0===e.mergedTiles.length&&0!==e.opacity&&0!==e.scale&&C(e);for(const e of l)e.active&&e.border&&2===e.mergedTiles.length&&0!==e.opacity&&C(e);B.lineWidth=.1,B.strokeStyle="white",B.globalAlpha=.1,B.beginPath();for(let e=0;e<i+1;e++)B.moveTo(e-L.x,-.05-L.y),B.lineTo(e-L.x,i+.05-L.y);for(let e=0;e<i+1;e++)B.moveTo(0-L.x,e-L.y),B.lineTo(i-L.x,e-L.y);B.stroke(),null!=window.myBorder&&(I.clearRect(0,0,M.width,M.height),I.fillStyle="#fff",I.beginPath(),I.arc(window.myBorder.x/i*M.width,window.myBorder.y/i*M.height,4,0,2*Math.PI),I.fill())}(r.borders,o.tiles),window.requestAnimationFrame(l)}));let U=!1;document.getElementById("playButton").onclick=()=>{D("name",document.getElementById("inputName").value),U||(U=!0,o.tiles=[],r.borders=[],window.onbeforeunload=function(e){return"Are you sure?"}),q("loadingContainer"),window.ws.iosend({type:"spawn",data:{name:document.getElementById("inputName").value}})}}))})();